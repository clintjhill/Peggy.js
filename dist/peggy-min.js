(function(){var a;(typeof exports!="undefined"&&exports!==null?exports:this).StringScanner=function(){a=function(a){this.source=a+"",this.reset();return this},a.prototype.scan=function(a){var b=a.exec(this.getRemainder());return b&&b.index===0?this.setState(b,{head:this.head+b[0].length,last:this.head}):this.setState([])},a.prototype.getRemainder=function(){return this.source.slice(this.head)},a.prototype.setState=function(a,b){var c,d;this.head=typeof (c=typeof b=="undefined"||b===null?undefined:b.head)!="undefined"&&c!==null?c:this.head,this.last=typeof (d=typeof b=="undefined"||b===null?undefined:b.last)!="undefined"&&d!==null?d:this.last,this.captures=a.slice(1);return this.match=a[0]},a.prototype.getSource=function(){return this.source},a.prototype.reset=function(){return this.setState([],{head:0,last:0})};return a}()})(),function(){var a;(typeof exports!="undefined"&&exports!==null?exports:this).Peggy=function(){a=function(a){if(!a)throw"A grammar name is required";this.name=a,this.rules={count:0};return this},a.version="0.7.0";var b="Boolean Number String Function Array Date RegExp Object".split(" ");a.types={};for(var c=0;c<b.length;c++)a.types["[object "+b[c]+"]"]=b[c].toLowerCase();a.type=function(b){return a.types[Object.prototype.toString.call(b)]},a.ruleType=function(b){var c=a.type(b);if(c==="regexp")return"terminal";if(c==="string"){if(b.charAt(0)===":")return"alias";return"stringTerminal"}if(c==="array")return b.type;if(c==="object")return"rule"},a.prototype={root:function(a,b,c){var d=this.rule(a,b,c);this.rules.root=d},rule:function(a,b,c,d,e){var f=this.buildRule(b||a,c);f.name=a,f.debugEngine=d,f.debugMatch=e,this.rules[this.rules.count]=f,this.rules.count+=1;return f},buildRule:function(b,c){var d=a.ruleType(b);if(d==="rule")return b;return{grammar:this,type:d,declaration:b,extension:c,isTerminal:d==="terminal"||d==="stringTerminal"}},resolveAlias:function(a){a=a.charAt(0)===":"?a.substr(1):a;for(var b=0;b<this.rules.count;b++)if(this.rules[b].name===a)return this.rules[b]},nonTerminal:function(a){var b=[];for(var c=0;c<a.length;c++)b.push(this.buildRule(a[c]));return b},repeat:function(a,b,c,d,e){return{name:a,declaration:this.buildRule(b),min:c||1,max:d||1/0,extension:e,type:"repeat"}},oneOrMore:function(a,b,c){return this.repeat(a,b,null,null,c)},zeroOrMore:function(a,b,c){return this.repeat(a,b,0,null,c)},zeroOrOne:function(a,b,c){return this.repeat(a,b,0,1,c)},parse:function(b){if(this.rules.count>0){var c=new StringScanner(b),d=this.rules.root||this.rules[0],e=new a.Match(a.engine.process(d,c)),f=e.result();if(f[d.name])return d.extension?d.extension(f[d.name].value):f[d.name].value}}},a.nonTerminals="sequence choice any all".split(" ");var d=function(a){return function(){var b=this.nonTerminal(arguments);b.type=a;return b}};for(var e=0;e<a.nonTerminals.length;e++){var f=a.nonTerminals[e];a.prototype[f]=d(f)}a.engine=function(){var b=function(a){if(a.type==="alias"){var b=a.declaration.substr(1);a=a.grammar.resolveAlias(a.declaration);if(!a)throw"Failed to parse: "+b+" rule is not defined.";a.name=b}return a},c=function(a,b){return b||{count:0,originalString:a.getSource()}},d=function(a){return a.length===1&&/\W/.test(a)?new RegExp("\\"+a):a.charAt(0)==="/"&&a.charAt(a.length-1)==="/"?new RegExp(a.substring(1,a.length-1)):new RegExp(a)},e=function(a,b,c){a.debugEngine&&debugger;var e=a.type==="stringTerminal"?d(a.declaration):a.declaration,f=b.scan(e);f&&(c[c.count]={rule:a,string:f},c.count+=1);return c},f=function(b,c,d){b.debugEngine&&debugger;var e={rule:b,count:0,string:""},f=0,h,i,j=function(a){d[d.count]=a,d.count+=1};if(a.type(b.declaration)==="array")for(h=0;h<b.declaration.length;h++)e=g(b.declaration[h],c,e);else if(b.type==="repeat"||b.type==="zeroOrMore")do f+=e.count,e=g(b.declaration,c,e);while(e.count>f);if(e.count>0)for(i=0;i<e.count;i++)e.string+=e[i].string;b.type==="sequence"?e.count>0&&j(e):b.type==="all"?e.count===b.declaration.length&&j(e):b.type==="choice"?e.count===1&&j(e):b.type==="repeat"&&e.count>=b.min&&e.count<=b.max&&j(e);return d},g=function(a,d,g){a=b(a),g=c(d,g);return a.isTerminal?e(a,d,g):f(a,d,g)};return{process:g}}(),a.Match=function(a){if(typeof a=="undefined")throw"Tree must be defined for Match";if(a.count===0)throw'Failed to parse "'+a.originalString+'"';this.tree=a;return this},a.Match.prototype={capture:function(a){var b;if(!a.count)this.processMatch(a);else{for(b=0;b<a.count;b++)this.capture(a[b]);this.processMatch(a)}},captureId:0,processMatch:function(a){this.captures=this.captures||{};var b;a.rule&&(b={match:a.string,value:this.getValues(a)},this.safeCollect(this.captures,a.rule.name||this.captureId,b),this.captureId+=1)},getValues:function(a){var b={},c,d;if(a.rule.isTerminal)return a.rule.extension?a.rule.extension(a.string):a.string;for(c=0;c<a.count;c++)d=a[c].rule,d.debugMatch&&debugger,d.isTerminal?b[d.name||c]=this.getValues(a[c]):(this.safeCollect(b,d.name||this.captureId,d.extension?d.extension(this.getValues(a[c])):this.getValues(a[c])),this.captureId+=1);return b},safeCollect:function(b,c,d){b[c]?a.types[toString.call(b[c])]!=="array"&&(b[c]=[b[c]],b[c].push(d)):b[c]=d},result:function(){this.capture(this.tree);return this.captures}};return a}()}();var peggy,grammar;Peggy.Grammar=peggy=new Peggy("grammar"),peggy.root("grammar",peggy.all(":name",":open",peggy.zeroOrMore("rules",":rule"),":close"),function(a){console.log("[Peggy.grammar]",a),grammar=window[a.name]=new Peggy(a.name);for(var b=0;b<a.rules.rule.length;b++){var c=a.rules.rule[b];grammar.rule(c.name,c.expression,c.block)}return grammar}),peggy.rule("rule",peggy.all(":ruleName",":expression",":block"),function(a){return{name:a.ruleName,expression:a.expression,block:a.block}}),peggy.rule("ruleName",peggy.sequence(/\w+\:/,":space"),function(a){return a[0].replace(":","")}),peggy.rule("expression",peggy.choice(":nonTerminal",":terminal"),function(a){return a.terminal||a.nonTerminal}),peggy.rule("nonTerminal",peggy.sequence("(",":list",")"),function(a){return a}),peggy.rule("list",peggy.repeat(":aliases",":alias",2),function(a){return a}),peggy.rule("alias",/\:\w+\,?/,function(a){return a.substr(1)}),peggy.rule("block",peggy.sequence(":scriptOpen",":script",":scriptClose",":comma"),function(a){return new Function("value",a.script)}),peggy.rule("script",/[^\}\}]+/,function(a){return a}),peggy.rule("name",peggy.sequence(/\w+/,":equal"),function(a){return a[0]}),peggy.rule("terminal",/(\/[\w\\]+[^,]\/)/,function(a){return a}),peggy.rule("open",peggy.sequence(":space","{",":space"),function(a){return a[1]||a[0]}),peggy.rule("scriptOpen",peggy.sequence(":space","{","{",":space"),function(a){return a}),peggy.rule("scriptClose",peggy.sequence(":space",/\}\}/,":space"),function(a){return a}),peggy.rule("close",peggy.sequence(":space","}",":space"),function(a){return a[1]||a[0]}),peggy.rule("equal",peggy.sequence(":space","=",":space"),function(a){return a[1]||a[0]}),peggy.rule("comma",peggy.sequence(":space",",",":space"),function(a){return a}),peggy.rule("space",/\s+/,function(a){return a})